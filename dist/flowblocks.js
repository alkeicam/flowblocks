!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e(require("joint")):"function"==typeof define&&define.amd?define(["joint"],e):"object"==typeof exports?exports.flowblocks=e(require("joint")):t.flowblocks=e(t.joint)}(this,(function(t){return function(t){var e={};function o(i){if(e[i])return e[i].exports;var r=e[i]={i:i,l:!1,exports:{}};return t[i].call(r.exports,r,r.exports,o),r.l=!0,r.exports}return o.m=t,o.c=e,o.d=function(t,e,i){o.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},o.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},o.t=function(t,e){if(1&e&&(t=o(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(o.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var r in t)o.d(i,r,function(e){return t[e]}.bind(null,r));return i},o.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return o.d(e,"a",e),e},o.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},o.p="",o(o.s=2)}([function(e,o){e.exports=t},function(t,e,o){o(0);t.exports=new class{linkGetParticipants(t,e){if(t.isLink())return{sourceElement:e.graph.getCell(t.get("source").id),sourcePort:t.get("source").port,targetElement:e.graph.getCell(t.get("target").id),targetPort:t.get("target").port}}}({})},function(t,e,o){o(0),o(1);const i=o(3),r=o(4);t.exports=new class{constructor(t){this.options={},Object.assign(this.options,t),this._registeredTypes={},this.flow={}}registerType(t,e,o,i){return this._registeredTypes[t]={name:t,statusDefinition:e,template:o,style:i},this._registeredTypes[t]}createFlow(t){return this.flow=r.create(t),this.flow}getBlock(t){return this.flow._blocks.find(e=>e.get("blockId")==t)}createBlock(t,e,o,r,s,n,a){var l=this._registeredTypes[t];if(l){var c=i.createBlank(o,l.template,l.statusDefinition,l.style);if(c.set("name",e),c.set("_type",l.name),o)this.flow._blocks.find(t=>t.get("blockId")==o)&&console.error("Duplicate flow Block for id: "+o);return r&&c.set("position",r),s&&c.set("size",s),n&&(-1==n.lastIndexOf("/")?c.set("icon","https://unpkg.com/flowblocks/dist/resources/img/svg/"+n+".svg"):c.set("icon",n)),this.flow.addBlock(c),c}throw new Error("Undefined type exception:"+t+". Please register type first with registerType().")}_dumpConnections(){this.flow._blocks.forEach(t=>{t._dumpConnections()})}enablePanAndZoom(t){if(t)try{this.flow.enablePanAndZoom(t)}catch(t){console.error(t)}}}({})},function(t,e,o){const i=o(0);t.exports=new class{constructor(t){this.options={defaultSize:{width:70,height:70},defaultPosition:{x:40,y:20},defaultPositionDelta:{dx:50,dy:50}},this.Model={},this.View={},Object.assign(this.options,t),this._initialize()}_initialize(){i.shapes.flowblocks={},this.Model=i.shapes.devs.Model.define("flowblocks.Block",{name:"",icon:"./resources/img/svg/agave.svg",status:"ERROR",statusMsg:"OK",blockId:void 0,debug:!0,errors:[],_styles:{americana:{icon:void 0,bodyColor:"#74b9ff",titleBarColor:"#ffeaa7",statusBarColor:"#fdcb6e",portInColor:"#00cec9",portOutColor:"#ff7675"},original:{icon:void 0,bodyColor:"#3DB5FF",titleBarColor:"rgb(255, 230, 206)",statusBarColor:"rgb(209, 226, 208)",portInColor:"#16A085",portOutColor:"#E74C3C"},cream:{icon:void 0,bodyColor:"#FAE8FF",titleBarColor:"#E1C2ED",statusBarColor:"#E1C2ED",portInColor:"#936DED",portOutColor:"#F2EAD7"}},_portsConnected:0,_type:void 0,_portConnections:[],attrs:{rect:{"ref-width":"100%",fill:"rgb(211, 55, 255)"},body:{fill:"#ffffff",stroke:"#000000"},link:{refWidth:"100%",refHeight:"100%",xlinkShow:"new",cursor:"pointer"},".status-err":{refHeight:"25%",fill:"rgb(204, 41, 0)",refY:"75%"},".fb-icon-rect":{fill:"#3DB5FF"},".fb-icon-image":{ref:".fb-icon-rect"},".fb-status-rect":{fill:"rgb(209, 226, 208)"},".fb-status-text":{ref:".fb-status-rect","text-anchor":"start",fill:"black","y-alignment":"middle"},".fb-label-rect":{fill:"rgb(255, 230, 206)"},".fb-label-text":{ref:".fb-label-rect","text-anchor":"start",fill:"black","y-alignment":"middle"}}},{markup:['<g class="rotatable">','<rect class="body"/>','<rect class="fb-icon-rect"/>','<image class="fb-icon-image" href="//resources/img/svg/agave.svg" />','<rect class="fb-label-rect"/>','<text class="fb-label-text">Label</text>','<rect class="fb-status-rect"/>','<text class="fb-status-text"></text>',"</g>"].join(""),initialize:function(){this.on("change:name change:icon change:status change:statusMsg change:size",(function(){this._updateMyModel(),this.trigger("flowblocks-block-update")}),this),this._updateMyModel(),i.shapes.devs.Model.prototype.initialize.apply(this,arguments)},api:function(){return["element.set('name','my label');","element.set('position', {x:30, y:10});","element.set('size', {width:50, height: 50});","element.set('icon', 'https://unpkg.com/flowblocks/dist/resources/img/svg/vase.svg');","element.style({titleBarColor: '#FADB50'});","element.getStatus();","element.freePorts();"]},getStatus(){return{valid:"OK"==this.get("status"),errors:this.get("errors")}},style(t){if(t)if("string"==typeof t||t instanceof String){var e=this.get("_styles")[t.toLocaleLowerCase()];e&&this.style(e)}else t.icon&&this.set("icon",t.icon),t.bodyColor&&this.attr(".fb-icon-rect/fill",t.bodyColor),t.titleBarColor&&this.attr(".fb-label-rect/fill",t.titleBarColor),t.statusBarColor&&this.attr(".fb-status-rect/fill",t.statusBarColor),t.portInColor&&this.getPorts().forEach(e=>{"in"==e.group&&this.portProp(e.id,"attrs/circle/fill",t.portInColor)}),t.portOutColor&&this.getPorts().forEach(e=>{"out"==e.group&&this.portProp(e.id,"attrs/circle/fill",t.portOutColor)})},freePorts(t){var e=this.getPorts().filter(e=>!t||e.group==t),o=this.get("_portConnections"),i=[];return e.forEach(t=>{o.find(e=>e.port==t.id)||i.push(t)}),i},_dumpConnections(){this.get("debug")&&console.log("Connections["+this.get("blockId")+"]: ",JSON.stringify(this.get("_portConnections")))},_recalculateStatus(){this.set("status","OK"),this.get("errors").length=0;var t=this.freePorts();t.length>0?(this.set("status","ERROR"),t.forEach(t=>{this.get("errors").push({code:"PORT_NOT_CONNECTED",cId:t.id,msg:"Port ["+t.id+"] is not connected"})})):(this.set("status","OK"),this.get("errors").length=0)},_handleDelete(t){var e=this.get("_portConnections").filter(e=>e.id!=t);this.set("_portConnections",e),this._recalculateStatus()},_handleDisconnect(t,e,o){if(null!=t){this.get("_portConnections").find(i=>i.port==e&&i.id==t.id&&i.linkId==o);var i=this.get("_portConnections").findIndex(i=>i.port==e&&i.id==t.id&&i.linkId==o);i>=0&&this.get("_portConnections").splice(i,1),this._recalculateStatus()}},_handleConnectFrom(t,e,o,i){var r={port:e,id:t.get("id"),bId:t.get("blockId"),type:t.get("_type"),targetPort:o,linkId:i};this.get("_portConnections").push(r),this._recalculateStatus()},_handleConnectTo(t,e,o,i){var r={port:e,id:t.get("id"),bId:t.get("blockId"),type:t.get("_type"),targetPort:o,linkId:i};this.get("_portConnections").push(r),this._recalculateStatus()},_recalculateRectWithLabel:function(t,e,o,i,r,s){this.get("attrs");var n=o*r.height,a=i*n,l=s+n/2,c=.1*r.width;return this.attr(t+"-rect/height",n),this.attr(t+"-rect/transform","translate(0,"+s+")"),this.attr(t+"-text/font-size",a),this.attr(t+"-text/transform","translate("+c+","+l+")"),this.attr(t+"-text/text",e),n},_recalculateRectWithIcon:function(t,e,o,i,r,s){var n=o*r.height;this.attr(t+"-rect/height",n),this.attr(t+"-rect/transform","translate(0,"+s+")");var a=i*n,l=r.width/2-a/2,c=s+n/2-a/2;return this.attr(t+"-image/height",a),this.attr(t+"-image/transform","translate("+l+","+c+")"),this.attr(t+"-image/href",e),n},_enableRemoval(t){var e=this.findView(t),o=e.getBBox().width-this.getBBox().width,i=this.getPorts(),r=!1,s=!1;i.forEach(t=>{"out"==t.group&&(s=!0),"in"==t.group&&(r=!0)}),o=r&&s?-o/2:s?-o:0;var n=new joint.elementTools.Remove({focusOpacity:.5,rotate:!0,x:"100%",offset:{x:o,y:0}}),a=new joint.dia.ToolsView({name:"basic-tools",tools:[n]});e.addTools(a),e.hideTools()},_updateMyModel:function(){var t=0,e={width:this.get("size").width,height:this.get("size").height,icon:this.get("icon"),name:this.get("debug")?this.get("name")+"["+this.get("blockId")+"]":this.get("name"),statusMessage:this.get("statusMsg")};t+=this._recalculateRectWithLabel(".fb-label",e.name,.2,.6,e,t),t+=this._recalculateRectWithIcon(".fb-icon",e.icon,.6,.8,e,t),t+=this._recalculateRectWithLabel(".fb-status",e.statusMessage,.2,.3,e,t)}},{}),i.shapes.flowblocks.BlockView=i.dia.ElementView.extend({initialize:function(){i.dia.ElementView.prototype.initialize.apply(this,arguments),this.listenTo(this.model,"flowblocks-block-update",(function(){this.update(),this.resize()}))}}),this.View=i.shapes.flowblocks.BlockView}createBlank(t,e,o,i){var r={PassThrough:this.createPassThroughElement,Start:this.createStartElement,Split:this.createSplitElement,Join:this.createJoinElement,End:this.createSinkElement};if(r[e]){var s=r[e].call(this,"",o);return s.set("blockId",t),s.style(i),s._recalculateStatus(),s}throw new Error("Unsuported template: "+e)}_createBaseOptions(){return{position:this.options.defaultPosition,size:this.options.defaultSize,ports:{groups:{in:{attrs:{".port-body":{fill:"#16A085",magnet:"passive"}}},out:{attrs:{".port-body":{fill:"#E74C3C"}}}}},attrs:{".label":{text:"Model","ref-x":.5,"ref-y":.2},rect:{fill:"#2ECC71"}}}}createSplitElement(t,e,o){var i=this._createBaseOptions();return i.inPorts=["in1"],i.outPorts=["out1","out2"],new this.Model(i)}createJoinElement(t,e,o){var i=this._createBaseOptions();return i.inPorts=["in1","in2"],i.outPorts=["out1"],new this.Model(i)}createPassThroughElement(t,e,o){var i=this._createBaseOptions();return i.inPorts=["in1"],i.outPorts=["out1"],new this.Model(i)}createStartElement(t,e,o){var i=this._createBaseOptions();return i.outPorts=["out1"],new this.Model(i)}createSinkElement(t,e,o){var i=this._createBaseOptions();return i.inPorts=["in1"],new this.Model(i)}}({})},function(t,e,o){const i=o(0),r=o(1);t.exports=new class{constructor(t){this.options={},this.graph={},this.paper={},this._blocks=[],Object.assign(this.options,t),this._initialize()}_initialize(){}create(t){return this.graph=new i.dia.Graph,this.paper=new i.dia.Paper({el:document.getElementById(t),width:1400,height:1e3,gridSize:1,model:this.graph,snapLinks:!0,linkPinning:!1,embeddingMode:!0,clickThreshold:5,defaultLink:new i.dia.Link({attrs:{".marker-target":{d:"M 10 0 L 0 5 L 10 10 z"},".connection":{stroke:"blue"},".marker-source":{d:"M 15 0 L 0 5 L 15 15 z",opacity:"0",stroke:"orange"},'.marker-arrowhead[end="source"]':{fill:"red",d:"M 10 0 L 0 5 L 10 10 z",opacity:"0"}}}),defaultConnectionPoint:{name:"boundary"},highlighting:{default:{name:"stroke",options:{padding:6}},embedding:{name:"addClass",options:{className:"highlighted-parent"}}},validateEmbedding:function(t,e){return e.model instanceof i.shapes.devs.Coupled},validateConnection:function(t,e,o,i,r,s){t.model,o.model;return e!=i&&"in"==i.getAttribute("port-group")&&t!=o},validateMagnet:function(t,e,o){return"passive"!=e.getAttribute("magnet")&&t.model.freePorts("out").length>0}}),joint.dia.Link.prototype.toolMarkup=['<g class="link-tool">','<g class="tool-remove" event="remove">','<circle r="11" />','<path transform="scale(.8) translate(-16, -16)" d="M24.778,21.419 19.276,15.917 24.777,10.415 21.949,7.585 16.447,13.087 10.945,7.585 8.117,10.415 13.618,15.917 8.116,21.419 10.946,24.248 16.447,18.746 21.948,24.248z" />',"<title>Remove link.</title>","</g>","</g>"].join(""),this._bindConnectionEvents(),this._bindToolsEvents(),this}_bindToolsEvents(){this.paper.on("element:mouseenter",(function(t){t.showTools()})),this.paper.on("element:mouseleave",(function(t){t.hideTools()}))}_bindConnectionEvents(){var t=this;this.paper.on("link:connect",(function(e,o,i,s,n){var a=r.linkGetParticipants(e.model,t),l=a.sourceElement,c=a.targetElement,h=a.sourcePort,d=a.targetPort;i.model,s.getAttribute("port");l._handleConnectTo(c,h,d,e.model.id),c._handleConnectFrom(l,d,h,e.model.id)})),this.paper.on("link:disconnect",(function(e,o,i,s,n){var a=r.linkGetParticipants(e.model,t),l=a.sourceElement,c=i.model,h=a.targetPort,d=a.sourcePort;a.targetElement;null!=c&&null!=l&&(l._handleDisconnect(c,d,e.model.id),c._handleDisconnect(l,h,e.model.id))})),this.graph.on("remove",(function(e){if(e.isLink()){var o=r.linkGetParticipants(e,t),i=o.sourceElement,s=o.targetElement,n=o.sourcePort,a=o.targetPort;null!=s&&null!=i&&(i._handleDisconnect(s,n,e.id),s._handleDisconnect(i,a,e.id))}else{console.log("delete");var l=e;t._blocks=t._blocks.filter(t=>t.id!=l.id),t._blocks.forEach(t=>{t._handleDelete(l)})}}))}addBlock(t){this._blocks.push(t),this.graph.addCell(t),t._enableRemoval(this.paper)}enablePanAndZoom(t){var e=t(document.querySelector("[joint-selector=svg]"),{fit:!1,panEnabled:!1,controlIconsEnabled:!0,center:!1,dblClickZoomEnabled:!1,minZoom:.3});this.paper.on("blank:pointerdown",(function(t,o,i){e.enablePan()})),this.paper.on("cell:pointerup blank:pointerup",(function(t,o){e.disablePan()}))}validate(){var t=!0,e=[];return this._blocks.forEach(o=>{var i=o.getStatus();i.valid||e.push({blockId:o.get("blockId"),errors:i.errors}),t=t&&i.valid}),{valid:t,errorBlocks:e}}}({})}])}));